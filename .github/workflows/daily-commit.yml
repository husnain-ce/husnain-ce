name: Daily Commit

on:
  schedule:
    # Runs every day at 00:00 UTC (adjust timezone as needed)
    # To change time, modify the cron: '0 0 * * *' format
    # Format: minute hour day month day-of-week
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual trigger from Actions tab

permissions:
  contents: write # Required for pushing commits

jobs:
  daily-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Verify PAT Token
      run: |
        if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
          echo "::error::PAT_TOKEN secret is not set!"
          echo "Please add your Personal Access Token to repository secrets as PAT_TOKEN"
          echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
          exit 1
        fi
        echo "PAT_TOKEN is configured"

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN }}
        ref: main

    - name: Setup Git config
      run: |
        # Use your actual GitHub email and username so commits count toward contributions
        # IMPORTANT: Email must match the one associated with your GitHub account
        git config --local user.email "bitsol44@gmail.com"
        git config --local user.name "husnain-ce"
        git config --local pull.rebase false
        git config --local push.default simple
        # Verify git config
        echo "Git user: $(git config user.name)"
        echo "Git email: $(git config user.email)"

    - name: Configure remote for PAT
      run: |
        # Configure remote URL to use PAT token for authentication
        # This ensures commits are attributed to your account, not the bot
        git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git
        echo "Remote configured with PAT token"

    - name: Sync with remote
      run: |
        git fetch origin main
        git checkout main
        git reset --hard origin/main

    - name: Create private directory for contributions
      run: |
        mkdir -p .github/.private

    - name: Make 10 daily contributions
      run: |
        DATE=$(date -u '+%Y-%m-%d')
        TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        RANDOM_ID=$(openssl rand -hex 4)
        
        # Verify we're using the correct identity before committing
        echo "Committing as: $(git config user.name) <$(git config user.email)>"
        
        # Make 10 separate commits for daily contributions
        for i in {1..10}; do
          # Use a more private location and less obvious file names
          FILE_NAME=".github/.private/activity-$(date -u +%s)-$i.txt"
          echo "$(date -u '+%s')" > "$FILE_NAME"
          echo "$TIMESTAMP" >> "$FILE_NAME"
          echo "$RANDOM_ID" >> "$FILE_NAME"
          
          git add "$FILE_NAME"
          if ! git diff --staged --quiet; then
            # More discrete commit messages
            git commit -m "docs: update activity log" --quiet
          else
            # If no changes, make an empty commit to ensure contribution count
            git commit -m "docs: update activity log" --allow-empty --quiet
          fi
          
          # Small delay to ensure unique timestamps
          sleep 2
        done
        
        # Show recent commits to verify author
        echo "Recent commits:"
        git log --oneline -5 --pretty=format:"%h - %an (%ae) : %s"

    - name: Sync and push all contributions
      run: |
        # Fetch latest changes
        git fetch origin main
        # Try to rebase on top of latest main
        if git rebase origin/main; then
          echo "Rebase successful"
        else
          # If rebase fails, abort and merge instead
          git rebase --abort 2>/dev/null || true
          git pull origin main --no-edit --no-rebase || true
        fi
        # Push all commits
        git push origin main

